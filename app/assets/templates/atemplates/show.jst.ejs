<form class="jumbotron col-xs-10 col-xs-offset-1">
  
  <p><input name="theme[recipient_email]" type="email" placeholder="Email to:" value="" autofocus></p>
  
  <p><input name="theme[sender_email]" type="email" placeholder="Subject" value="<%= Alistpress.current_user_email %>"></p>
  
  <p class="theme-title">
    <input type="text" value="<%= atemplate.escape('title') %>" name="theme[title]">    
  </p>

  <p class="theme-content">
    <textarea id="wysihtml5" class="col-xs-12" name="theme[content]">
      <%= atemplate.escape('content') %>
    </textarea>
  </p>
  
  <p>
    <button class="save-theme btn btn-primary pull-right" style="border-radius:0;" type="submit">Save</button>
  </p>  
<!-- </div> -->
</form>

<button class="send-theme btn btn-success pull-right" style="border-radius:0;" type="submit" data-loading-text="Sending...">Send</button>

<script type="text/javascript" charset="utf-8">
$(document).ready(function(){
  
  $('#wysihtml5').each(function(i, elem) {
    $(elem).wysihtml5({
    	"font-styles": true,
    	"emphasis": true,
    	"lists": true, 
    	"html": true, 
    	"link": true,
    	"image": true,
    	"color": false,
      "events": {
        "focus": function() {
          $('.wysihtml5-sandbox').contents().find('body').on("keydown", function(event) {          
            var numLoops = _.size($(this).children());                        
            var keyCode = event.keyCode;
            
            if (keyCode == 9){
              event.preventDefault(); 
              
              for (var i = 0; i < numLoops; i++) {     
                var content = $(this).children()[i];           
                var sentence = content.innerHTML;                
                var _match;
                var reg = new RegExp(/\{{(.*?)\}}/g);
                                
                var allNodes = content.childNodes.length;
                var thisNode;
                
                if (match = reg.exec(sentence)) { 
                  _match = match; 
                }               
                
                for (var j = 0; j < allNodes; j++) {
                  if (_match) {
                    thisNode = content.childNodes[j];
                    var range = document.createRange();
                    range.setStart(thisNode, _match.index);
                    range.setEnd(thisNode, _match.index + _match[0].length);
                
                    var selection = document.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);                        
                    debugger
                    break;              
                  }                 
                };                                  
              }                         
            }      
         });                               
        }
      } 
    }); 
  });
  
  $('.send-theme').click(function () {
     var btn = $(this)
     btn.button('loading')
   });

});
</script>